# 1.26，2025-08-09

**I2C 从设备、改进的浮点数运算与原生代码生成器、STM32N6 及 ESP32C2 支持**

本次 MicroPython 版本发布引入了 `machine.I2CTarget` 功能，允许通过 Python 代码实现 I2C 从设备。该功能已在 alif、esp32、mimxrt、rp2、samd、stm32 和 zephyr 版本上可用。在最简单的情况下，它可以创建一个连接到字节数组（或类似缓冲区）的 I2C 寄存器 / 内存设备，使 I2C 主设备能够读取和写入该字节数组。对于更复杂的场景，I2CTarget类提供了一组中断，Python 代码可对这些中断做出响应，从而实现任意 I2C 设备。更多细节和示例请参见文档。

本版本在浮点数支持方面进行了多方面改进。首先，浮点数的格式化（打印）功能已重写，显著提高了浮点数repr的可逆性。也就是说，对浮点数进行格式化后再解析，应返回原始值。在 MicroPython 中，能够正确通过repr格式化并重新解析的浮点数比例，单精度约为 28%，双精度约为 38%，而在标准构建配置下，现已分别提升至 98.5%（单精度）和 99.8%（双精度）。除了能更精确地打印浮点数外，这在将浮点数保存到.mpy文件时也大有帮助，因为这意味着它们可以被加载回相同的值。

其次，编译器现在支持将浮点数作为常量处理。浮点数现在可以（与整数一起）在算术运算中进行折叠，并且可以作为`const`赋值的一部分。这有助于优化字节码，因为常量浮点表达式现在可以在编译时计算，而不是在运行时。

第三项浮点数改进涉及对象表示 C，其中浮点数存储在直接对象值中，而不是堆上。在这个对象模块中，浮点数只能占用 30 位，因此单精度数的最后两位会丢失。以前它们只是被截断，但现在从对象恢复浮点值时会应用一种启发式算法，将最后两位从倒数第三位和第四位复制过来。这减轻了向零的偏差，总体上改善了使用这种表示法时的浮点计算。

原生和 viper 代码生成器后端已得到改进，可生成更优的机器码，例如在加载和存储时使用更紧凑的指令。这适用于所有支持的架构：ARM、Thumb、Xtensa、RISC-V 32、x86 和 x64。Thumb v1（例如 RP2040）现在支持大于 12 位的长跳转，允许将更大的 Python 函数编译到这种原生架构。此外，内联 Xtensa 汇编器现在实现了大多数 LX3 操作码，新增的包括 addx2、subx2、ssl 和 ssr 等。

本版本支持两款新的微控制器：STM32N6xx 和 ESP32-C2（又名 ESP8684）。STM32N6xx 是意法半导体的新款微控制器，运行频率为 800MHz，具有大量 RAM 和机器学习加速器。MicroPython 现在支持这个型号微控制器的 USB、XSPI 内存映射外部闪存、文件系统、基本外设和深度睡眠功能。ESP32-C2 由乐鑫推出，是一款小型低成本的 RISC-V 微控制器，具有 WiFi 和 BLE 功能。在这款微控制器上运行的 MicroPython 支持 REPL、文件系统、GPIO、I2C、ADC、PWM、定时器、WiFi 和 BLE。

time模块支持的日期范围现已标准化，在所有平台上保持一致。`time()`、`localtime()`和`mktime()`函数现在能在合理的日期范围内正常工作，至少从 1970 年到 2099 年，不受平台所用纪元的影响。

MicroPython 虚拟机现在能够避免在对字节数组和内存视图对象进行下标操作时为切片分配堆内存，例如 `bytearray_obj[a:b] = c` 这样的表达式。切片对象现在分配在 C 栈上，有助于减少内存波动，并允许在堆被锁定时（例如在硬中断处理程序中）执行此类表达式。这一改进朝着 MicroPython 尽可能少用堆的大方向迈进，使执行更具确定性。

核心运行时的其他改进包括：支持在星号导入中使用`__all__`；支持 PEP487 的`__set_name__`特殊方法；支持 `str.format` 中的 `_b/o/x` 说明符；数组现在可以从任何可迭代对象扩展，而不仅仅是从具有缓冲区协议的对象。新增了一个 MicroPython 特定的 `sys.implementation._thread` 属性，当线程启用时存在，用于指示所使用的线程模型（GIL 或不安全 / 无 GIL）。

`framebuf` 模块现在支持将只读数据块传输到帧缓冲区，这在实现可存储在 ROM 中的自定义字体时很有帮助。tls 模块中的 DTLS 实现现在启用了 DTLS HelloVerify 和抗重放保护（针对 mbedTLS 后端），允许实现完善的 DTLS 服务器。lwIP 套接字层现在有一个传入 UDP 和原始数据包的队列（以前只能容纳一个未处理的数据包），使 UDP 协议更加健壮和高效。

Mpremote 有几项改进。新增了 fs tree 命令，模仿 Unix 的 tree 命令，并包含 -s 和 -h 选项以在输出中显示文件大小。df 命令已增强，使用新的无参数 `vfs.mount()` 查询，并显示更完善的已挂载文件系统摘要。mip install 命令现在使用哈希来跳过已存在的文件。借助 platformdirs 辅助包，用户 config.py 文件的位置在许多不同的操作系统和配置风格中更具可移植性。还支持没有 errno 模块的目标设备，改进了断开连接处理，并更好地通过 USB-CDC 端口检测 ESP 设备。

`mpy_ld.py` 链接器现在可以根据请求解析固定地址符号，例如在 ESP8266 上，它可以链接到 ROM 提供的函数。现在还支持 ARMv6M（RP2040）上的 ABS32 文本重定位。这些改进扩展了可为此类目标编译的 C 扩展集。

本版本中更新的库包括：lwIP 更新至 STABLE-2_2_1_RELEASE，LittleFS 更新至 v2.11，libhydrogen 更新至最新版本，stm32lib 更新以支持 STM32N6。

测试套件有许多改进，包括测试和测试运行器。部分原因是为了辅助新的 Octoprobe 测试框架，该框架提供硬件在环测试。持续集成测试现在还包括未定义行为 sanitizer（UBSan）构建、地址 sanitizer（ASan）构建、long-long unix 变体，以及对象表示 C 的测试。MicroPython 有大量测试！

alif 移植版现在支持引脚中断，改进了 SPI 传输，并且 I2C 配置现在允许更改 SCL 和 SDA 引脚。

esp32 移植版已更新为使用 ESP-IDF v5.4.2，现在支持 ESP32-C2。大多数基于 ESP32 的开发板现在在启动时会自动检测其闪存大小，并根据闪存大小自动创建适当的 vfs 分区。这使得相同的固件镜像可以在具有不同闪存大小的开发板上工作。该端口还新增了 esp32.PCNT 类以及 machine.Counter 和 machine.Encoder，它们可以计数输入边沿，包括电机旋转。PWM 类已改进，其 API 现在与其他硬件一致。支持 LAN8670 PHY，以及新的 `esp32.idf_task_info()` 函数（与 micropython-lib 中的新 utop 包配合使用很有用）。`UART.sendbreak()` 方法已重写，使其在执行期间不会重新配置 UART。

nrf 移植版对其 UART REPL 进行了修复和改进，使其更健壮，并能与 mpremote 配合使用。现在在 nRF52 微控制器上使用正确的 iRAM 地址执行原生代码。nrf 对 `machine.enable_irq()` 和 `machine.disable_irq()` 的实现已重新设计，使其使用代码与其他硬件通用，由于 `enable_irq()` 的签名变化，这是一个突破性变化（仅在 nrf 开发板上）。以前的签名是 enable_irq()，现在的签名与其他端口和文档一致，为enable_irq(state)，其中 state 是 disable_irq() 的返回值。

rp2 版本现在默认启用压缩错误消息，这将固件大小减少约 3000 字节。pico-sdk 警报池现在（再次，代替自定义软时间代码）用于节能延迟，并且轻睡眠已得到改进。在具有 32 个以上 GPIO 的 RP2350 上修复了开漏模式，并添加了对硬 IRQ 定时器回调的支持。

webassembly 版本改进了其与 JavaScript 的 FFI 接口：改进了 “has” 和 “get” 代理，修复了 self 与 JavaScript 方法的绑定，实现了 JsProxy 对象的相等性，并在可能时重用 JsProxy 引用以改善 Python 端 JavaScript 对象的相等性关系。

zephyr 版本已更新为使用 Zephyr v4.0.0，并进行了许多改进：添加了 PWM 支持，UART 现在由环形缓冲区驱动的中断驱动，并可以设置波特率和其他参数，GPIO 支持开漏模式，启用了 SoftI2C 和 SoftSPI，zephyr.FlashArea 类现在包含枚举可用分区的常量。REPL 的可靠性也得到了提高，现在在默认配置中支持 ctrl-C。BLE 现在可以使用标准的 BLE.register_services() 方法在运行时创建服务。还添加了其他一些小功能，使 zephyr 端口与其他裸机端口的行为一致，包括：启动时执行 boot.py 和 main.py，适当地将 /lib 添加到 sys.path，在 sys 模块中启用 stdin/out/err，以及导入 .mpy 文件的能力，启用 await/async 关键字。该端口现在使用标准化的 ROM 配置级别，默认级别为 “basic”。

本版本新增的开发板有：GARATRONIC_PYBSTICK26_ESP32C3 和 SPARKFUN_IOT_REDBOARD_ESP32（esp32）、SPARKFUN_REDBOARD_TURBO 和 SPARKFUN_SAMD21_DEV_BREAKOUT（samd）、NUCLEO_N657X0 和 OPENMV_N6（stm32）、beagleplay_cc1352p7、nrf5340dk、nrf9151dk 和 rpi_pico（zephyr）。

与上一版本相比，各端口选定构建的代码大小变化（文本部分的绝对和百分比变化）如下：

```
   bare-arm:    -96  -0.168%
minimal x86:   -207  -0.112%
   unix x64:   -376  -0.045%
      stm32:  +3776  +0.966%
     cc3200:   +392  +0.212%
    esp8266:  +3484  +0.498%
      esp32: +19064  +1.122%
     mimxrt:  +3600  +0.970%
 renesas-ra:  +1296  +0.207%
        nrf:  +1140  +0.607%
        rp2:   +556  +0.245%  (RPI_PICO board)
        rp2:  +2252  +0.245%  (RPI_PICO_W board)
       samd:  +3296  +1.233%
```

这些代码大小变化的主要原因是：
- bare-arm、minimal：各种代码大小改进，包括优化的整数可变参数处理
- unix：移除静态 PATH 变量（减少 bss 大小），实现 DTLS HelloVerify 和抗重放保护（增加大小）
- stm32：实现 machine.I2CTarget，提高浮点数格式化的准确性和时间函数的范围，改进原生代码生成器和内联汇编器，将 LittleFS 更新至 v2.11
- cc3200：在核心功能级别启用 io.IOBase，避免在对内置类型进行下标操作时为切片分配堆内存
- esp8266：向内联汇编器添加更多 LX3 操作码，将 LittleFS 更新至 v2.11，改进原生代码生成器，添加浮点常量折叠
- esp32：更新至 IDF 5.4.2（+10k），实现 machine.I2CTarget
- mimxrt：实现 machine.I2CTarget，提高浮点数格式化的准确性，改进原生代码生成器，添加浮点常量折叠，将 LittleFS 更新至 v2.11
- renesas-ra：提高浮点数格式化的准确性，改进原生代码生成器，添加浮点常量折叠
- nrf：提高浮点数格式化的准确性，启用 io.IOBase，标准化时间函数的范围
- rp2（RPI_PICO）：启用压缩错误消息（-3k），实现 machine.I2CTarget，提高浮点数格式化的准确性
- rp2（RPI_PICO_W）：启用压缩错误消息（-3k），实现 machine.I2CTarget，实现 DTLS HelloVerify 和抗重放保护
- samd：实现 machine.I2CTarget，提高浮点数格式化的准确性，改进原生代码生成器，实现浮点常量折叠

感谢所有为本版本做出贡献的人：Alessandro Gatti、Andrea Giammarchi、Andrew Leech、Angus Gratton、Anson Mansfield、Anton Blanchard、Ayush Singh、Chris Webb、Christian Lang、Damien George、Daniel Campora、Daniël van de Giessen、David Schneider、David Yang、Detlev Zundel、Dryw Wade、dubiousjim、Elvis Pfutzenreuter、ennyKey、Garatronic、Herwin Grobben、iabdalkader、IhorNehrutsa、Jeff Epler、Jim Mussared、Jonathan Hogg、Jos Verlinde、Koudai Aono、Malcolm McKellips、Matt Trentini、Maureen Helm、Meir Armon、Patrick Joy、Peter Harper、Phil Howard、purewack、Rick Sorensen、robert-hh、root、SiZiOUS、stijn、TianShuang Ke、Vdragon、Yanfeng Liu、Yoctopuce dev、Yuuki NAGAO。


